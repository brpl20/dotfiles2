#!/usr/bin/env bash
set -euo pipefail

ROOT="${PULLER_ROOT:-$HOME}"
CONFIG="${PULLER_CONFIG:-$HOME/.config/puller/repos.conf}"

if [[ ! -f "$CONFIG" ]]; then
  echo "Puller config not found: $CONFIG" >&2
  exit 1
fi

while IFS= read -r line || [[ -n "$line" ]]; do
  path="${line%%#*}"
  path="${path%"${path##*[![:space:]]}"}"
  path="${path#"${path%%[![:space:]]*}"}"
  [[ -z "$path" ]] && continue

  if [[ "$path" == /* ]]; then
    repo_path="$path"
  else
    repo_path="$ROOT/$path"
  fi

  if [[ ! -d "$repo_path" ]]; then
    echo "Skipping missing repo $repo_path" >&2
    continue
  fi

  echo "Pulling $repo_path"
  if ! git -C "$repo_path" pull; then
    echo "Pull failed for $repo_path" >&2
  fi
done <"$CONFIG"
